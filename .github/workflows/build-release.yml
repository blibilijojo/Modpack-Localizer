# .github/workflows/build-release.yml

name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: Check directory and files
      run: |
        Write-Output "Current directory: $(Get-Location)"
        Write-Output "Files in current directory:"
        Get-ChildItem
        Write-Output "Checking if updater.py exists:"
        if (Test-Path -Path "updater.py" -PathType Leaf) { Write-Output "YES" } else { Write-Output "NO" }
        Get-Content updater.py -ErrorAction SilentlyContinue || Write-Output "Cannot read updater.py"

    - name: Build Main Executable (Modpack-Localizer-Pro.exe)
      run: |
        pyinstaller --noconfirm --onefile --windowed --name "Modpack-Localizer-Pro" --add-data "core/term_database.json;." `
          --hidden-import "psutil" `
          --hidden-import "tkinter" `
          --hidden-import "ttkbootstrap" `
          --hidden-import "cryptography" `
          --hidden-import "requests" `
          --hidden-import "charset_normalizer" `
          --hidden-import "certifi" `
          --hidden-import "idna" `
          --hidden-import "urllib3" `
          --hidden-import "openai" `
          --hidden-import "httpx" `
          --hidden-import "gui" `
          --hidden-import "gui.main_window" `
          --hidden-import "gui.settings_window" `
          --hidden-import "gui.settings_components.basic_settings" `
          --hidden-import "gui.settings_components.ai_settings" `
          --hidden-import "gui.settings_components.resource_pack_settings" `
          --hidden-import "gui.settings_components.github_settings" `
          --hidden-import "gui.settings_components.advanced_settings" `
          --hidden-import "gui.tab_pack_settings" `
          --hidden-import "gui.tab_settings_unified" `
          --hidden-import "gui.custom_widgets" `
          --hidden-import "gui.ui_utils" `
          --hidden-import "gui.dialogs" `
          --hidden-import "gui.translation_workbench" `
          --hidden-import "gui.find_replace_dialog" `
          --hidden-import "gui.theme_utils" `
          --hidden-import "gui.dictionary_search_window" `
          --hidden-import "gui.user_dictionary_editor" `
          --hidden-import "gui.quest_workflow_manager" `
          --hidden-import "gui.comprehensive_processing_dialog" `
          --hidden-import "gui.enhanced_comprehensive_processing" `
          --hidden-import "gui.github_upload_ui" `
          --hidden-import "gui.dialog.github_version_select" `
          --hidden-import "services" `
          --hidden-import "services.ai_translator" `
          --hidden-import "services.github_service" `
          --hidden-import "services.punctuation_corrector" `
          --hidden-import "utils" `
          --hidden-import "utils.config_manager" `
          --hidden-import "utils.logger_setup" `
          --hidden-import "utils.file_utils" `
          --hidden-import "utils.error_logger" `
          --hidden-import "utils.dictionary_searcher" `
          --hidden-import "utils.update_checker" `
          --hidden-import "utils.session_manager" `
          --hidden-import "utils.retry_logic" `
          --hidden-import "core" `
          --hidden-import "core.translator" `
          --hidden-import "core.builder" `
          --hidden-import "core.extractor" `
          --hidden-import "core.pack_builder" `
          --hidden-import "core.dictionary_manager" `
          --hidden-import "core.term_database" `
          --hidden-import "core.decision_engine" `
          --hidden-import "core.data_aggregator" `
          --hidden-import "core.orchestrator" `
          --hidden-import "core.quest_converter" `
          --hidden-import "core.workflow" `
          --hidden-import "core.models" `
          --hidden-import "core.exceptions" `
          main.py

    - name: Get release notes from tag
      id: get_release_notes
      # 采用健壮的多行文本输出方法，以处理包含特殊字符的 Release Notes
      run: |
        $RELEASE_NOTES = git tag -l --format='%(contents)' ${{ github.ref_name }}
        $DELIMITER = "ghadelimiter_$(Get-Random)"
        Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append -InputObject @"
        body<<$DELIMITER
        $RELEASE_NOTES
        $DELIMITER
        "@
      shell: pwsh

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body: ${{ steps.get_release_notes.outputs.body }}
        files: dist/Modpack-Localizer-Pro.exe